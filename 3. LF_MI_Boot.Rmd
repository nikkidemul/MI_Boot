---
title: "3. LF_MI_Boot"
author: "N de Mul"
date: "2023-11-20"
output: word_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#LF_MIB 

We will perform the imputation first. 

```{r}
library(mice)
set.seed(600)

system.time(imp.dry <- mice(incompletedata, maxit=0, printFlag=TRUE, visitsequence='monotone', seed=600))
testimp <-complete(imp.dry)
```

Then check classes, methods and correlations
```{r}
cormytotaldata <- lapply(incompletedata, as.numeric)
cormytotaldata <- data.frame(cormytotaldata)
mycormatvar <- round(cor(cormytotaldata, use="pairwise.complete.obs"),3)
table(mycormatvar >=0.7 | mycormatvar <=-0.7) #so no correlations higher then 0.7. 
table(mycormatvar >=0.5 | mycormatvar <=-0.5) # so a few are correlated at the 0.5 level, which? 

#check in excel: 
#write.table(mycormatvar, "correlationmatrix.csv", sep=";")

#tiff and fev1 are correlated as one would expect (0.568). 

```

```{r}
mymethod <- imp.dry$method
mymethod
```

The right categories. 

```{r}
var2impute <- which(mymethod!="")
pred <- imp.dry$predictorMatrix
#don't let tiff and fev1 predict each other? 
pred["fev1_compl", "tiff_compl"] <- 0
pred["tiff_compl", "fev1_compl"] <- 0

system.time(imp.dry2 <- mice(incompletedata, meth=mymethod, pred=pred, maxit=0, printFlag =T, visitSequence = 'monotone', seed=21212))
testimp2 <- complete(imp.dry2)
rm(imp.dry)

#postprocessing
postproc <- imp.dry2$post
postproc["fev1_compl"] <- "imp[[j]][,i] <- squeeze(imp[[j]][,i],c(60,150))"
postproc["tiff_compl"] <- "imp[[j]][,i] <- squeeze(imp[[j]][,i],c(60,150))"

m <- 10
maxit <- 10 

system.time(imp.dry3 <- mice(incompletedata, meth=mymethod, pred=pred, maxit=0, printFlag=T, visitSequence = 'monotone', seed=600))
test3 <- complete(imp.dry3)

summary(test3$Hemoglobine)
```

Then run imputation: 
```{r}
system.time(imputedset <- mice(data=incompletedata, m=m, maxit=maxit, method=mymethod, predictorMatrix = pred, printFlag=T, seed=600, post=postproc, visitSequence = 'monotone'))
```
Check imputation: 

```{r}
plot(imputedset)
```

```{r}
densityplot(imputedset) #does look good! 
```


Finish dataprepping: 

```{r}
Myimp <- as.data.frame(complete(imputedset, action="long"))

#dummy_Neotx
table(Myimp$Neotx)
Myimp <- Myimp %>% mutate(dummy_Neotx1 = ifelse(Neotx==1,1,0)) %>% mutate(dummy_Neotx3 = ifelse(Neotx==3,1,0)) %>% mutate(dummy_Neotx1 = as.factor(dummy_Neotx1)) %>% mutate(dummy_Neotx3 = as.factor(dummy_Neotx3))

#eGFRcat
table(Myimp$eGFRcat)
table(d$eGFRcat)
Myimp <- Myimp %>% mutate(eGFR = eGFRcat) %>% mutate(eGFR = ifelse(eGFR==2 | eGFR==1,1,0))
Myimp <- Myimp %>% mutate(eGFR = as.factor(eGFR))


#categorical ASAclass
table(Myimp$ASA)
Myimp <- Myimp %>% mutate(dummy_ASA12 = ifelse(ASA==1 | ASA==2,1,0)) %>% mutate(dummy_ASA34 = ifelse(ASA==3 | ASA==4,1,0)) %>% mutate(dummy_ASA12 = as.factor(dummy_ASA12)) %>% mutate(dummy_ASA34 = as.factor(dummy_ASA34))

#tumor T stadium 
# Myimp <- Myimp %>%  mutate(T34 = ifelse((pt == "T3" | pt =="T4"),1,0)) %>% mutate(T34 = as.factor(T34))


#Cardiovascular variable
Myimp <- Myimp %>% mutate(comorb_cardiovasc = ifelse((comorb_mi==1 | comorb_coronary==1 | comorb_heart_failure==1 | comorb_per_vasc==1 | comorb_cerebrovasc==1),1,0)) %>% mutate(comorb_cardiovasc = as.factor(comorb_cardiovasc)) 

#Hb cat
Myimp <- Myimp %>% mutate(Hbcat = ifelse((Hemoglobine < 7.5),1,ifelse((Hemoglobine > 8.5),2,0)))

#dummy Hb
Myimp <- Myimp %>% mutate(dummy_Hblow = ifelse(Hbcat==1,1,0)) %>% mutate(dummy_Hbhigh = ifelse(Hbcat==2,1,0)) %>% mutate(dummy_Hblow = as.factor(dummy_Hblow)) %>% mutate(dummy_Hbhigh = as.factor(dummy_Hbhigh))

```



Dan willen we ook nog een nieuwe lijst maken waar die transformaties in gedaan zijn. 

```{r}
Myimp2 <- as.data.frame(complete(imputedset, action="long", include=TRUE))

#dummy_Neotx
Myimp2 <- Myimp2 %>% mutate(dummy_Neotx1 = ifelse(Neotx==1,1,0)) %>% mutate(dummy_Neotx3 = ifelse(Neotx==3,1,0)) %>% mutate(dummy_Neotx1 = as.factor(dummy_Neotx1)) %>% mutate(dummy_Neotx3 = as.factor(dummy_Neotx3))

#eGFRcat
Myimp2 <- Myimp2 %>% mutate(eGFR = eGFRcat) %>% mutate(eGFR = ifelse(eGFR==2 | eGFR==1,1,0))
Myimp2 <- Myimp2 %>% mutate(eGFR = as.factor(eGFR))


#categorical ASAclass
Myimp2 <- Myimp2 %>% mutate(dummy_ASA12 = ifelse(ASA==1 | ASA==2,1,0)) %>% mutate(dummy_ASA34 = ifelse(ASA==3 | ASA==4,1,0)) %>% mutate(dummy_ASA12 = as.factor(dummy_ASA12)) %>% mutate(dummy_ASA34 = as.factor(dummy_ASA34))

#tumor T stadium 
# Myimp2 <- Myimp2 %>%  mutate(T34 = ifelse((pt == "T3" | pt =="T4"),1,0)) %>% mutate(T34 = as.factor(T34))

#Cardiovascular variable
Myimp2 <- Myimp2 %>% mutate(comorb_cardiovasc = ifelse((comorb_mi==1 | comorb_coronary==1 | comorb_heart_failure==1 | comorb_per_vasc==1 | comorb_cerebrovasc==1),1,0)) %>% mutate(comorb_cardiovasc = as.factor(comorb_cardiovasc)) 

#Hb cat
Myimp2 <- Myimp2 %>% mutate(Hbcat = ifelse((Hemoglobine < 7.5),1,ifelse((Hemoglobine > 8.5),2,0)))

#dummy Hb
Myimp2 <- Myimp2 %>% mutate(dummy_Hblow = ifelse(Hbcat==1,1,0)) %>% mutate(dummy_Hbhigh = ifelse(Hbcat==2,1,0)) %>% mutate(dummy_Hblow = as.factor(dummy_Hblow)) %>% mutate(dummy_Hbhigh = as.factor(dummy_Hbhigh))

table(Myimp2$outcome)

Final_imp <- as.mids(Myimp2, where=NULL, .imp=".imp", .id=".id")

Final_imp <- complete(Final_imp, "all")

saveRDS(Final_imp, file=paste0("Final_imp", ".rds"))
saveRDS(Myimp, file=paste0("Myimp", ".rds"))
```

When dealing with Firth, all data should be numeric (all factor variables included). We will repeat the above but will make special dataset for Firth: 


Firth: 

```{r}
Myimp2 <- as.data.frame(complete(imputedset, action="long", include=TRUE))

#dummy_Neotx
Myimp2 <- Myimp2 %>% mutate(dummy_Neotx1 = ifelse(Neotx==1,1,0)) %>% mutate(dummy_Neotx3 = ifelse(Neotx==3,1,0)) %>% mutate(dummy_Neotx1 = as.factor(dummy_Neotx1)) %>% mutate(dummy_Neotx3 = as.factor(dummy_Neotx3))

#eGFRcat
Myimp2 <- Myimp2 %>% mutate(eGFR = eGFRcat) %>% mutate(eGFR = ifelse(eGFR==2 | eGFR==1,1,0))
Myimp2 <- Myimp2 %>% mutate(eGFR = as.factor(eGFR))


#categorical ASAclass
Myimp2 <- Myimp2 %>% mutate(dummy_ASA12 = ifelse(ASA==1 | ASA==2,1,0)) %>% mutate(dummy_ASA34 = ifelse(ASA==3 | ASA==4,1,0)) %>% mutate(dummy_ASA12 = as.factor(dummy_ASA12)) %>% mutate(dummy_ASA34 = as.factor(dummy_ASA34))

#tumor T stadium 
# Myimp2 <- Myimp2 %>%  mutate(T34 = ifelse((pt == "T3" | pt =="T4"),1,0)) %>% mutate(T34 = as.factor(T34))

#Cardiovascular variable
Myimp2 <- Myimp2 %>% mutate(comorb_cardiovasc = ifelse((comorb_mi==1 | comorb_coronary==1 | comorb_heart_failure==1 | comorb_per_vasc==1 | comorb_cerebrovasc==1),1,0)) %>% mutate(comorb_cardiovasc = as.factor(comorb_cardiovasc)) 

#Hb cat
Myimp2 <- Myimp2 %>% mutate(Hbcat = ifelse((Hemoglobine < 7.5),1,ifelse((Hemoglobine > 8.5),2,0)))

#dummy Hb
Myimp2 <- Myimp2 %>% mutate(dummy_Hblow = ifelse(Hbcat==1,1,0)) %>% mutate(dummy_Hbhigh = ifelse(Hbcat==2,1,0)) %>% mutate(dummy_Hblow = as.factor(dummy_Hblow)) %>% mutate(dummy_Hbhigh = as.factor(dummy_Hbhigh))

Myimp3 <- Myimp2
x <- sapply(Myimp3, is.factor)
Myimp3[ ,x] <- as.data.frame(apply(Myimp3[, x], 2, as.numeric))

Final_impF <- as.mids(Myimp3, where=NULL, .imp=".imp", .id=".id")

Final_impF <- complete(Final_impF, "all")

saveRDS(Final_impF, file=paste0("Final_impF", ".rds"))
```



